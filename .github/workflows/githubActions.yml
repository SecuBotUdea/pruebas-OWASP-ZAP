name: OWASP ZAP Security Scan
on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Ejecutar semanalmente
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: ZAP Full Scan
      uses: zaproxy/action-full-scan@v0.10.0
      continue-on-error: true
      with:
        target: 'https://nextjs-boilerplate-mu-lilac-67.vercel.app/'
        cmd_options: '-a -J report_json.json'
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload JSON Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-json-report
        path: report_json.json
        retention-days: 30
    
    - name: Convert JSON to SARIF
      if: always() && success() || failure()
      run: |
        python scripts/convert_zap_to_sarif.py report_json.json zap_results.sarif
      env:
        REPO_ROOT: "file://${{ github.workspace }}/"
    
    - name: Fix SARIF URIs
      if: always() && success() || failure()
      run: |
        # Crear un archivo de placeholder para vincular los resultados
        mkdir -p placeholder
        echo "<!-- Application placeholder for ZAP scan results -->" > placeholder/index.html
        echo "# ZAP Security Scan Results" > placeholder/README.md
        
        # Corregir las URIs en el archivo SARIF
        python -c "
        import json
        import sys
        
        with open('zap_results.sarif', 'r') as f:
            sarif = json.load(f)
        
        # Asegurar que todas las URIs usen el esquema 'file://'
        for run in sarif.get('runs', []):
            for artifact in run.get('artifacts', []):
                if 'location' in artifact and 'uri' in artifact['location']:
                    if artifact['location']['uri'].startswith('http'):
                        artifact['location']['uri'] = 'placeholder/index.html'
            
            for result in run.get('results', []):
                for location in result.get('locations', []):
                    phys_loc = location.get('physicalLocation', {})
                    if 'artifactLocation' in phys_loc:
                        if phys_loc['artifactLocation'].get('uri', '').startswith('http'):
                            phys_loc['artifactLocation']['uri'] = 'placeholder/index.html'
        
        with open('zap_results.sarif', 'w') as f:
            json.dump(sarif, f, indent=2)
        
        print('SARIF file fixed')
        "
    
    - name: Validate SARIF
      if: always() && success() || failure()
      run: |
        python -c "
        import json
        
        try:
            with open('zap_results.sarif', 'r') as f:
                sarif = json.load(f)
            
            print('SARIF validation:')
            print(f\"  Version: {sarif.get('version')}\")
            print(f\"  Runs: {len(sarif.get('runs', []))}\")
            
            for i, run in enumerate(sarif.get('runs', [])):
                print(f\"  Run {i+1}:\")
                print(f\"    Tool: {run.get('tool', {}).get('driver', {}).get('name', 'Unknown')}\")
                print(f\"    Results: {len(run.get('results', []))}\")
                
                # Verificar helpUri
                for rule in run.get('tool', {}).get('driver', {}).get('rules', []):
                    help_uri = rule.get('helpUri', '')
                    if isinstance(help_uri, str) and '<p>' in help_uri:
                        print(f\"    WARNING: Invalid helpUri found: {help_uri[:50]}...\")
        
        except Exception as e:
            print(f'Error validating SARIF: {e}')
        "
    
    - name: Upload SARIF to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always() && success() || failure()
      continue-on-error: true  # Continuar incluso si falla la subida
      with:
        sarif_file: zap_results.sarif
        category: owasp-zap
        checkout_path: ${{ github.workspace }}
    
    - name: Upload SARIF Report as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-sarif-report
        path: |
          zap_results.sarif
          placeholder/
        retention-days: 30
    
    - name: Normalize ZAP Report
      if: always()
      run: python scripts/normalize_zap_report.py
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Upload Normalized Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: normalized-report
        path: normalized_report.json
        retention-days: 30
